RCC_APB2ENR 	EQU 0x40021018	
RCC_APB1ENR	EQU 0x4002101C

TIM2_CR1 	EQU 0x40000000
TIM2_PSC	EQU 0x40000028
TIM2_ARR	EQU 0x4000002C
TIM2_CCR3	EQU 0x4000003C
TIM2_CCER	EQU	0x40000020
TIM2_CCMR2	EQU	0x4000001C
TIM2_EGR	EQU 0x40000014
	
AFIO_MAPR	EQU 0x40010004	
	
GPIOA_CRL	EQU 0x40010800
GPIOA_CRH	EQU 0x40010804
GPIOA_IDR	EQU 0x40010808
GPIOA_ODR	EQU 0x4001080C

GPIOB_CRL	EQU	0x40010C00
GPIOB_CRH	EQU	0x40010C04
GPIOB_IDR	EQU	0x40010C08
GPIOB_ODR	EQU	0x40010C0C
	
AFIO_EXTICR2 EQU 0x4001000C
	
EXTI_IMR EQU 0x40010400
EXTI_EMR	EQU 0x40010404
EXTI_RTSR	EQU 0x40010408
EXTI_FTSR	EQU 0x4001040C
EXTI_PR	EQU 0x40010414
	
NVIC_ISER0	EQU 0xE000E100
	AREA main, CODE, READONLY
	EXPORT __main
	EXPORT EXTI4_IRQHandler
		
__main
	LDR	R1,=RCC_APB2ENR
	LDR R0,[R1]
	ORR R0,R0,#0xFC		;enable the clocks for GPIOs
	STR R0,[R1]
	
	LDR R1,=RCC_APB1ENR
	LDR R0,[R1]
	ORR R0,R0,#(1<<0)
	STR R0,[R1]
	
	LDR R1,=GPIOA_CRL
	LDR R0,=0x44444B44
	STR R0,[R1]			;PA2 as output

	LDR R0, =GPIOB_CRL
	LDR R1, =0x84444
	STR R1, [R0]
	
	LDR R1,=GPIOA_CRH
	LDR R0,=0x33333333
	STR R0,[R1]

	LDR R1,=AFIO_EXTICR2
	LDR R0,=1
	STR R0,[R1]

	LDR R1,=EXTI_IMR
	LDR R0,=0x10
	STR R0,[R1]
	
	LDR R1,=EXTI_FTSR
	LDR R0,=0x10
	STR R0,[R1]
	
	LDR R1,=NVIC_ISER0
	LDR R0,=0x400
	STR R0,[R1]

	LDR R1,=TIM2_CCER
	LDR R0,[R1]
	ORR R0,R0,#(1<<8)
	STR R0,[R1]
	
	LDR R1,=TIM2_CCMR2
	LDR R0,[R1]
	MOV R0,#0x0068
	STR R0,[R1]
	
	LDR R1,=TIM2_CR1		;//dem xuong 
	LDR R0,[R1]
	MOV R0,#0x90
	STR R0,[R1]
	
	LDR R1,=TIM2_PSC
	LDR R0,[R1]
	MOV R0,#719
	STR R0,[R1]
	
	LDR R1,=TIM2_ARR
	LDR R0,[R1]
	MOV R0,#999
	STR R0,[R1]
	
	LDR R1,=TIM2_EGR		
	LDR R0,[R1]
	MOV R0,#1
	STR R0,[R1]
	
	LDR R1,=TIM2_CR1
	LDR R0,[R1]
	ORR R0,R0,#0x01
	STR R0,[R1]

loop
	MOV R4,#0
loop_dc
	LDR R0,=TIM2_CCR3
	STR R4,[R0]
	BL delay
	ADD R4,#250
	CMP R4,#1000
	BLE loop_dc
	B loop
	
EXTI4_IRQHandler
	LDR R1, =GPIOA_ODR
	LDR R0,[R1]
	EOR	R0,R0,#(1<<8)
	STR R0, [R1]
	BX LR

	
	
delay 
		LDR R0,=50
d_L1	LDR R1,=6000
d_L2	SUBS R1,R1,#1
		BNE d_L2
		SUBS R0,R0,#1
		BNE d_L1
		BNE delay
		BX LR	
	
		END